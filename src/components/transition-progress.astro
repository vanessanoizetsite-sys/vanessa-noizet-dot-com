<c-transition-progress
	transition:persist
	transition-name="transition-progress"
	class="fixed top-0 left-0 z-50 hidden h-[2px] w-full origin-left bg-blue-400 transition-transform duration-300 data-[loading]:block"
></c-transition-progress>

<script>
	customElements.define(
		'c-transition-progress',
		class PageTransitionIndicator extends HTMLElement {
			#rafId: number | null = null
			#currentProgress = 0
			#lastUpdate = 0

			connectedCallback() {
				document.addEventListener('astro:before-preparation', this.#handleStart)
				document.addEventListener('astro:after-swap', this.#handleComplete)
				document.addEventListener('astro:page-load-error', this.#handleError)
			}

			disconnectedCallback() {
				document.removeEventListener('astro:before-preparation', this.#handleStart)
				document.removeEventListener('astro:after-swap', this.#handleComplete)
				document.removeEventListener('astro:page-load-error', this.#handleError)
				this.#cancelAnimation()
			}

			#handleStart = () => {
				this.#progress = 0
				this.#lastUpdate = performance.now()
				this.#startProgress()
				this.toggleAttribute('data-loading', true)
			}

			#handleComplete = () => {
				this.#cancelAnimation()
				this.#progress = 100
				setTimeout(() => {
					this.#progress = 0
					this.toggleAttribute('data-loading', false)
				}, 300)
			}

			#handleError = () => {
				this.#cancelAnimation()
				this.#progress = 0
				this.toggleAttribute('data-loading', false)
			}

			#startProgress() {
				const animate = (timestamp: number) => {
					const elapsed = timestamp - this.#lastUpdate

					if (elapsed >= 200) {
						if (this.#progress < 90) {
							this.#progress += Math.random() * 10
							if (this.#progress > 90) this.#progress = 90
						}
						this.#lastUpdate = timestamp
					}

					if (this.#progress < 90) {
						this.#rafId = requestAnimationFrame(animate)
					}
				}

				this.#rafId = requestAnimationFrame(animate)
			}

			set #progress(value: number) {
				this.#currentProgress = value
				this.style.setProperty('transform', `scaleX(${value / 100})`)
			}

			get #progress() {
				return this.#currentProgress
			}

			#cancelAnimation() {
				if (this.#rafId) {
					cancelAnimationFrame(this.#rafId)
					this.#rafId = null
				}
			}
		}
	)
</script>
